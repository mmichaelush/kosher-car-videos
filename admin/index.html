<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ניהול תוכן - CAR-טיב</title>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
<script>
var JsonArrayAdapter = {
fromFile: function(content) {
// תיקון קריטי: בדיקה אם התוכן ריק, null או undefined לפני שמנסים לפענח
if (!content || content.trim() === "") {
return { videos: [] };
}

try {
var parsed = JSON.parse(content);

if (Array.isArray(parsed)) {
// זיהוי אם זה קובץ ערוצים
if (parsed.length > 0 && parsed[0].hasOwnProperty('channel_name')) {
return { channels: parsed };
}
// ברירת מחדל: סרטונים
return { videos: parsed };
}
// אם זה כבר אובייקט, החזר אותו כמו שהוא
return parsed;
} catch (e) {
console.warn("JSON parsing failed, returning empty list.", e);
return { videos: [] };
}
},

toFile: function(data) {
if (data.videos) {
return JSON.stringify(data.videos, null, 2);
}
if (data.channels) {
return JSON.stringify(data.channels, null, 2);
}
return JSON.stringify(data, null, 2);
}
};

CMS.registerCustomFormat('json_root_array', 'json', JsonArrayAdapter);

if (window.netlifyIdentity) {
window.netlifyIdentity.on("init", user => {
if (!user) {
window.netlifyIdentity.on("login", () => {
document.location.href = "/admin/";
});
}
});
}
</script>
</body>
</html>
