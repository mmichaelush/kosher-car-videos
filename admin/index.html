<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ניהול תוכן - CAR-טיב</title>
  <link rel="icon" href="../data/assets/images/favicon.ico" type="image/x-icon">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin-styles.css">

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>

  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  
  <script>
    (function(CMS, React) {
      if (!CMS || !React) {
        console.error("Decap CMS or React not loaded, cannot register custom preview.");
        return;
      }

      const h = React.createElement;

      const VideoItemPreview = function(props) {
        const { item } = props; // 'item' is an Immutable.js Map
        const videoId = item.get('id');
        const title = item.get('title') || 'סרטון ללא כותרת';
        const isValidId = typeof videoId === 'string' && videoId.match(/^[\\w-]{11}$/);

        const videoPlayer = isValidId
            ? h('div', {
                style: {
                    position: 'relative', paddingBottom: '56.25%', height: 0, overflow: 'hidden',
                    maxWidth: '100%', background: '#000', borderRadius: '8px', border: '1px solid #ddd'
                }},
                h('iframe', {
                    src: 'https://www.youtube.com/embed/' + videoId,
                    frameBorder: '0',
                    allow: 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture',
                    allowFullScreen: true,
                    style: { position: 'absolute', top: 0, left: 0, width: '100%', height: '100%' }
                })
            )
            : h('div', {
                style: { padding: '20px', backgroundColor: '#f1f5f9', borderRadius: '8px', textAlign: 'center',
                         color: '#64748b', border: '1px dashed #cbd5e1'}},
                'ID לא תקין. לא ניתן להציג תצוגה מקדימה.'
            );

        return h('div', { style: { margin: '20px 0', padding: '15px', border: '1px solid #e2e8f0', borderRadius: '8px' }},
            h('h3', { style: { fontSize: '18px', fontWeight: '500', marginBottom: '12px' }}, title),
            videoPlayer
        );
      };

      const VideosCollectionPreview = function(props) {
        const entry = props.entry;
        const videos = entry.getIn(['data', 'videos']); // Get the list of videos
        
        if (!videos || videos.size === 0) {
            return h('div', {style: {padding: '20px'}}, 'אין סרטונים בקובץ.');
        }

        return h('div', { style: { padding: '20px', fontFamily: 'Rubik, sans-serif' }}, 
          videos.map(function(video, index) {
            return h(VideoItemPreview, { key: index, item: video });
          })
        );
      };
      
      CMS.registerPreviewTemplate('videos_collection', VideosCollectionPreview);

    })(window.CMS, window.React);

    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>
</body>
</html>
